# 04-MySQL索引&视图&存储过程

### 1.MySQL索引

#### 1.1 什么是索引

在数据库表中，对字段建立索引可以大大提高查询速度。通过善用这些索引，可以令MySQL的查询和 运行更加高效。 

如果合理的设计且使用索引的MySQL是一辆兰博基尼的话，那么没有设计和使用索引的MySQL就是 一个人力三轮车。拿汉语字典的目录页（索引）打比方，我们可以按拼音、笔画、偏旁部首等排序的目 录（索引）快速查找到需要的字

#### 1.2常见索引分类

| 索引名称                | 说明                                                         |
| ----------------------- | ------------------------------------------------------------ |
| 主键索引（primary key） | 主键是一种唯一性索引,每个表只能有一个主键, 用于标识数据表中的每一 条记录 |
| 唯一索引（unique）      | 唯一索引指的是，索引列的所有制都只能出现一次，必须唯一       |
| 普通索引（index）       | 最常见的索引，作用就是加快数据的访问速度                     |

**MySQL将一个表的索引都保存在同一个索引文件中，如果对数据进行增删改操作，MySQL都会自动的更新索引**

![](https://gitee.com/iscn/md_images/raw/master/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/QQ%E6%88%AA%E5%9B%BE20211006102037.png)

##### 1.2.1主键索引（PRIMARY KEY)

**特点：主键是一种唯一性索引，每个表只能有一个主键，用于标识数据表中的某一条记录。**

​	一个表可以没有主键，但最多只能有一个主键，并且主键值不能包含null。

语法格式

- 创建表的时候直接添加主键索引（最常用）

```mysql
CREATE TABLE 表名(
-- 添加主键 (主键是唯一性索引,不能为null,不能重复,)
字段名 类型 PRIMARY KEY,
);
```

- 修改表结构 添加主键索引

```mysql
ALTER TABLE 表名 ADD PRIMARY KEY ( 列名 )
```

##### 1.2.2 唯一索引（UNIQUE）

​	**特点：索引列的所有值都只能出现一次，必须唯一**

​	唯一索引可以保证数据记录的唯一性。事实上，在许多场合，人们创建唯一索引的目的往往不是为了 提高访问速度，而只是为了避免数据出现重复。

语法格式

- 创建表的时候添加唯一索引

```mysql
CREATE TABLE 表名(
列名 类型(长度),
-- 添加唯一索引
UNIQUE [索引名称] (列名)
);
```

- 使用create语句创建：在已有的表上创建索引

```mysql
create unique index 索引名 on 表名(列名(长度))
```

- 修改表结构添加索引

```mysql
ALTER TABLE 表名 ADD UNIQUE ( 列名 )
```

##### 1.2.3 普通索引（INDEX）

​	普通索引（由关键字KEY或INDEX定义的索引）的唯一任务是加快对数据的访问速度。因此，应该只 为那些最经常出现在查询条件（WHERE column=）或排序条件（ORDERBY column）中的数据列创建 索引。

语法格式

使用create index语句创建：在已有的表上创建索引

```mysql
create index 索引名 on 表名(列名[长度])
```

修改表结构添加索引

```mysql
ALTER TABLE 表名 ADD INDEX 索引名 (列名)
```

##### 1.2.4 删除索引

- 由于索引会占用一定的磁盘空间，因此，为了避免影响数据库的性能，应该及时删除不再使用的索引

语法格式

```mysql
ALTER TABLE 表名 DROP INDEX 索引名;
```

#### 1.3 索引的优缺点总结

- 添加索引首先应考虑在where及order by涉及的列上建立索引
- 索引的优点
  - 大大的提高查询速度
  - 可以显著的减少查询中分组和排序的时间
- 索引的缺点
  - 创建索引和维护索引需要时间，而且数据量越大时间越长
  - 当对表中的数据进行增、删、改时，索引也要同时进行维护，降低了数据的维护速度

### 2. MySQL视图

#### 2.1 什么是视图

1. 视图是一种虚拟表

2. 视图建立在已有表的基础上, 视图赖以建立的这些表称为基表。
3. 向视图提供数据内容的语句为 SELECT 语句, 可以将视图理解为存储起来的 SELECT 语句.
4. 视图向用户提供基表数据的另一种表现形式

#### 2.2视图的作用

- 权限控制时可以使用
  - 比如,某几个列可以运行用户查询,其他列不允许,可以开通视图 查询特定的列, 起到权限控制的 作用
- 简化复杂的多表查询
  - 视图 本身就是一条查询SQL,我们可以将一次复杂的查询 构建成一张视图, 用户只要查询视图 就可以获取想要得到的信息(不需要再编写复杂的SQL)
  - 视图主要就是为了简化多表的查询

#### 2.3 视图的使用

##### 2.3.1 创建视图

1）语法格式

```mysql
create view 视图名 [column_list] as select语句;
view: 表示视图
column_list: 可选参数，表示属性清单，指定视图中各个属性的名称，默认情况下，与SELECT语句中查询
的属性相同
as : 表示视图要执行的操作
select语句: 向视图提供数据内容
```

2）创建一张视图

```mysql
#1. 先编写查询语句
#查询所有商品 和 商品的对应分类信息
SELECT * FROM products p LEFT JOIN category c ON p.`category_id` = c.`cid`;
#2.基于上面的查询语句,创建一张视图
CREATE VIEW products_category_view
AS SELECT * FROM products p LEFT JOIN category c ON p.`category_id` = c.`cid`;
```

3）查询视图，就当作一张只读的表操作就可以

```mysql
SELECT * FROM products_category_view;
```

##### 2.3.2 通过视图进行查询

需求：查询各个分类下的商品平均价格

```mysql
#通过 多表查询
SELECT
cname AS '分类名称',
AVG(p.`price`) AS '平均价格'
FROM products p LEFT JOIN category c ON p.`category_id` = c.`cid`
GROUP BY c.`cname`;
# 通过视图查询 可以省略连表的操作
SELECT
cname AS '分类名称',
AVG(price) AS '平均价格'
FROM products_category_view GROUP BY cname;
```

#### 2.4 视图与表的区别

- 视图是建立在表的基础上，表存储数据库中的数据，而视图只是做一个数据的展示
- 通过视图不能改变表中数据（一般情况下视图中的数据都是表中的列，经过计算得到的结果，不允许更新）
- 删除视图，表不受影响，而删除表，视图不再起作用

### 3. MySQL存储过程

#### 3.1什么是存储过程

- MySQL 5.0版本开始支持存储过程
- 存储过程（Stored Procedure）是一种在数据库中存储复杂程序，以便外部程序调用的一种数据 库对象。存储过程是为了完成特定功能的SQL语句集，经编译创建并保存在数据库中，用户可通过 指定存储过程的名字并给定参数(需要时)来调用执行。
- **简单理解：存储过程其实就是一堆SQL语句的合并，中间加入了一些逻辑控制**

#### 3.2 存储过程的优缺点

- 优点：
  - 存储过程一旦调试完成后，就可以稳定运行，（前提是，业务需求更相对稳定，没有变化）
  - 存储过程减少业务系统与数据库的交互，降低耦合，数据库交互更加快捷（应用服务器，与 数据库服务器不在同一个地区）
- 缺点：
  - 在互联网行业中，大量使用MySQL，MySQL的存储过程与Oracle的相比较弱，所以较少使 用，并且互联网行业需求变化较快也是原因之一
  - 尽量在简单的逻辑中使用，存储过程移植十分困难，数据库集群环境，保证各个库之间存储 过程变更一致也十分困难。
  - 阿里的代码规范里也提出了禁止使用存储过程，存储过程维护起来的确麻烦；

### 4.DCL（数据控制语言）

MySql默认使用的都是 root 用户，超级管理员，拥有全部的权限。除了root用户以外，我们还可以通 过DCL语言来定义一些权限较小的用户, 分配不同的权限来管理和维护数据库。

#### 4.1创建用户

语法格式

```mysql
CREATE USER '用户名'@'主机名' IDENTIFIED BY '密码';
```

| 参数   | 说明                                                         |
| ------ | ------------------------------------------------------------ |
| 用户名 | 创建的新用户，登录名称                                       |
| 主机名 | 指定用户在哪个主机上可以登录，本地用户可用localhost<br />如果想让用户可以从任意远程主机登录，可以使用通配符% |
| 密码   | 登录密码                                                     |

需求：创建admin1用户，只能在localhost这个服务器登录MySQL服务器，密码为123456

```mysql
CREATE USER 'admin1'@'localhost' IDENTIFIED BY '123456';
```

创建 admin2 用户可以在任何电脑上登录 mysql 服务器，密码为 123456

```mysql
CREATE USER 'admin2'@'%' IDENTIFIED BY '123456';
```

#### 4.2用户授权

创建好的用户，需要进行授权

语法格式

```mysql
GRANT 权限 1, 权限 2... ON 数据库名.表名 TO '用户名'@'主机名';
```

| 参数 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| 权限 | 授予用户的权限，如CREATE、ALTER、SELECT、INSERT、UPDATE等<br />如果在授予索引的权限则使用ALL |
| ON   | 用来指定权限针对哪些数据库和表                               |
| TO   | 表示将权限赋予某个用户                                       |

1) 给 admin1 用户分配对 db4 数据库中 products 表的 操作权限：查询

```mysql
GRANT SELECT ON db4.products TO 'admin1'@'localhost';
```

#### 4.3 查看权限

语法格式

```mysql
SHOW GRANTS FOR '用户名'@'主机名';
```

#### 4.4 删除用户

语法格式

```mysql
DROP USER '用户名'@'主机名';
```

#### 4.5 查询用户

选择名为 mysql的数据库, 直接查询 user表即可

```mysql
-- 查询用户
SELECT * FROM USER;
```

